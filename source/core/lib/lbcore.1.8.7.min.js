class ObjUserFunc{constructor(e){this.ident=e,this.paramCount=0,this.varIdents=[],this.ops=[],this.tokens=[],this.sourceLineMap=new Map}toString(){var e="";e+="Name: "+this.ident+"\n",e+="Parameter #: "+this.paramCount+"\n\n",e+="Variables:\n------------\n";for(var r=0;r<this.varIdents.length;r++)e+=r+":  "+this.varIdents[r]+"\n";e+="\n",e+="Ops:\n------\n";for(var n=0;n<this.ops.length;n++){e+=n+":  "+opNames[this.ops[n][0]];for(var t=1;t<this.ops[n].length;t++)e+=", "+this.ops[n][t];e+="\n"}return e+="\n",e}}class ObjNativeFunc{constructor(e,r,n,t){this.ident=e,this.paramMin=r,this.paramMax=n,this.jsFunc=t}}class ObjArray{constructor(){this.items=[],this.dimSizes=[]}reDim(e){for(var r=1,t=0;t<e.length;t++){if(0>=e[t])return!1;r*=e[t]}return this.dimSizes=e,this.items=Array(r).fill(0),!0}getLinearIndex(e){var r=0,t=1;if(e.length!=this.dimSizes.length)return-1;for(var a=0;a<this.dimSizes.length;a++){if(0>e[a]||e[a]>=this.dimSizes[a])return-1;r+=e[a]*t,t*=this.dimSizes[a]}return r}addItem(e,r=-1){return 1==this.dimSizes.length?(-1==r&&(r=this.items.length-1),0>r||r>=this.items.length)?"Array index '"+r+"' out of bounds.":(this.items.splice(r,0,e),this.dimSizes[0]++,""):"Can only add items to a one-dimensional array."}removeItem(e){return 1==this.dimSizes.length?0>e||e>=this.items.length?"Array index '"+e+"' out of bounds.":(this.items.splice(e,1),this.dimSizes[0]--,""):"Can only remove items from a one-dimensional array."}}class ObjStructure{constructor(e){this.def=e,this.fieldMap=new Map;for(var r=0;r<e.fieldIdents.length;r++)this.fieldMap.set(e.fieldIdents[r],0)}}const TOKEN_ERROR=0,TOKEN_EOF=1,TOKEN_NEWLINE=2,TOKEN_COLON=3,TOKEN_UNDERSCORE=4,TOKEN_LEFT_PAREN=5,TOKEN_RIGHT_PAREN=6,TOKEN_LEFT_BRACKET=7,TOKEN_RIGHT_BRACKET=8,TOKEN_COMMA=9,TOKEN_DOT=10,TOKEN_MINUS=11,TOKEN_PLUS=12,TOKEN_SLASH=13,TOKEN_STAR=14,TOKEN_PERCENT=15,TOKEN_EQUAL=16,TOKEN_NOT_EQUAL=17,TOKEN_GREATER=18,TOKEN_GREATER_EQUAL=19,TOKEN_LESS=20,TOKEN_LESS_EQUAL=21,TOKEN_NOT=22,TOKEN_OR=23,TOKEN_AND=24,TOKEN_CARET=25,TOKEN_TRUE=30,TOKEN_FALSE=31,TOKEN_STRING_LIT=32,TOKEN_NUMBER_LIT=33,TOKEN_IDENTIFIER=34,TOKEN_VAR=40,TOKEN_ARRAY=41,TOKEN_PRINT=42,TOKEN_IF=43,TOKEN_THEN=44,TOKEN_ELSE=45,TOKEN_END=46,TOKEN_WHILE=47,TOKEN_WEND=48,TOKEN_FOR=49,TOKEN_TO=50,TOKEN_STEP=51,TOKEN_NEXT=52,TOKEN_REDIM=53,TOKEN_CLS=54,TOKEN_WHTERBTOBJ=55,TOKEN_DO=56,TOKEN_LOOP=57,TOKEN_EXIT=58,TOKEN_FUNCTION=59,TOKEN_RETURN=60,TOKEN_WAIT=61,TOKEN_STRUCTURE=62,TOKEN_NEW=63;class Token{constructor(e,r,n,t){this.type=e,this.lexeme=r,this.literal=n,this.lineNum=t}toString(){return this.lineNum+" "+this.lexeme+" "+this.type+" "+this.literal}}const SCOPE_GLOBAL=0,SCOPE_LOCAL=1,OPCODE_LOAD_TRUE=1,OPCODE_LOAD_FALSE=2,OPCODE_LOAD_INT=3,OPCODE_LOAD_NATIVE_FUNC=4,OPCODE_LOAD_USER_FUNC=5,OPCODE_LOAD_LIT=6,OPCODE_LOAD_VAR=7,OPCODE_STORE_VAR=8,OPCODE_STORE_VAR_PERSIST=9,OPCODE_POP=10,OPCODE_SUB=11,OPCODE_ADD=12,OPCODE_DIV=13,OPCODE_MUL=14,OPCODE_MOD=15,OPCODE_NEGATE=16,OPCODE_NOT=17,OPCODE_EQUAL=18,OPCODE_GREATER=19,OPCODE_LESS=20,OPCODE_POW=21,OPCODE_PRINT=22,OPCODE_JUMP=23,OPCODE_JUMP_IF_FALSE=24,OPCODE_JUMP_IF_FALSE_PERSIST=25,OPCODE_JUMP_IF_TRUE=26,OPCODE_JUMP_IF_TRUE_PERSIST=27,OPCODE_END=28,OPCODE_CALL_FUNC=29,OPCODE_CREATE_ARRAY=30,OPCODE_REDIM_ARRAY=31,OPCODE_LOAD_ARRAY_ITEM=32,OPCODE_STORE_ARRAY_ITEM_PERSIST=33,OPCODE_CLS=34,OPCODE_CHECK_COUNTER=35,OPCODE_INCREMENT_COUNTER=36,OPCODE_RETURN=37,OPCODE_PAUSE=38,OPCODE_CREATE_STRUCT=39,OPCODE_LOAD_STRUCT_FIELD=40,OPCODE_STORE_STRUCT_FIELD_PERSIST=41;opNames=[],opNames[OPCODE_LOAD_TRUE]="LOAD_TRUE",opNames[OPCODE_LOAD_FALSE]="LOAD_FALSE",opNames[OPCODE_LOAD_INT]="LOAD_INT",opNames[OPCODE_LOAD_NATIVE_FUNC]="LOAD_NATIVE_FUNC",opNames[OPCODE_LOAD_USER_FUNC]="LOAD_USER_FUNC",opNames[OPCODE_LOAD_LIT]="LOAD_LIT",opNames[OPCODE_LOAD_VAR]="LOAD_VAR",opNames[OPCODE_STORE_VAR]="STORE_VAR",opNames[OPCODE_STORE_VAR_PERSIST]="STORE_VAR_PERSIST",opNames[OPCODE_POP]="POP",opNames[OPCODE_SUB]="SUB",opNames[OPCODE_ADD]="ADD",opNames[OPCODE_DIV]="DIV",opNames[OPCODE_MUL]="MUL",opNames[OPCODE_MOD]="MOD",opNames[OPCODE_NEGATE]="NEGATE",opNames[OPCODE_NOT]="NOT",opNames[OPCODE_EQUAL]="EQUAL",opNames[OPCODE_GREATER]="GREATER",opNames[OPCODE_LESS]="LESS",opNames[OPCODE_POW]="POW",opNames[OPCODE_PRINT]="PRINT",opNames[OPCODE_JUMP]="JUMP",opNames[OPCODE_JUMP_IF_FALSE]="JUMP_IF_FALSE",opNames[OPCODE_JUMP_IF_FALSE_PERSIST]="JUMP_IF_FALSE_PERSIST",opNames[OPCODE_JUMP_IF_TRUE]="JUMP_IF_TRUE",opNames[OPCODE_JUMP_IF_TRUE_PERSIST]="JUMP_IF_TRUE_PERSIST",opNames[OPCODE_END]="END",opNames[OPCODE_CALL_FUNC]="CALL_FUNC",opNames[OPCODE_CREATE_ARRAY]="CREATE_ARRAY",opNames[OPCODE_REDIM_ARRAY]="REDIM_ARRAY",opNames[OPCODE_LOAD_ARRAY_ITEM]="LOAD_ARRAY_ITEM",opNames[OPCODE_STORE_ARRAY_ITEM_PERSIST]="STORE_ARRAY_ITEM_PERSIST",opNames[OPCODE_CLS]="CLS",opNames[OPCODE_CHECK_COUNTER]="CHECK_COUNTER",opNames[OPCODE_INCREMENT_COUNTER]="INCREMENT_COUNTER",opNames[OPCODE_RETURN]="RETURN",opNames[OPCODE_PAUSE]="PAUSE",opNames[OPCODE_CREATE_STRUCT]="CREATE_STRUCT",opNames[OPCODE_LOAD_STRUCT_FIELD]="LOAD_STRUCT_FIELD",opNames[OPCODE_STORE_STRUCT_FIELD_PERSIST]="STORE_STRUCT_FIELD_PERSIST";class StructureDef{constructor(e){this.ident=e,this.fieldIdents=[],this.tokens=[]}toString(){var e="";e+="Name: "+this.ident+"\n",e+="Fields:\n------------\n";for(var r=0;r<this.varIdents.length;r++)e+=r+":  "+this.fieldIdents[r]+"\n";return e+="\n",e}}class Bytecode{constructor(){this.nativeFuncs=[],this.userFuncs=[],this.structDefs=[],this.literals=[]}toString(){var e="";e+="Literals:\n-----------\n";for(var r=0;r<this.literals.length;r++)e+=r+":  "+this.literals[r]+"\n";e+="\n\n",e+="Structure Defs:\n------------\n\n";for(var n=0;n<this.structDefs.length;n++)e+=this.structDefs[n].toString()+"\n";e+="Functions:\n------------\n\n";for(var t=0;t<this.userFuncs.length;t++)e+=this.userFuncs[t].toString()+"\n";return e}}const lbVersion="1.8.7",stdNativeFuncs=[new ObjNativeFunc("rnd",0,0,funcRnd),new ObjNativeFunc("time",0,0,funcTime),new ObjNativeFunc("int",1,1,funcInt),new ObjNativeFunc("len",1,1,funcLen),new ObjNativeFunc("upper",1,1,funcUpper),new ObjNativeFunc("lower",1,1,funcLower),new ObjNativeFunc("left",2,2,funcLeft),new ObjNativeFunc("right",2,2,funcRight),new ObjNativeFunc("mid",2,3,funcMid),new ObjNativeFunc("trim",1,1,funcTrim),new ObjNativeFunc("ltrim",1,1,funcLTrim),new ObjNativeFunc("rtrim",1,1,funcRTrim),new ObjNativeFunc("instr",2,3,funcInstr),new ObjNativeFunc("abs",1,1,funcAbs),new ObjNativeFunc("asc",1,1,funcAsc),new ObjNativeFunc("chr",1,1,funcChr),new ObjNativeFunc("min",2,2,funcMin),new ObjNativeFunc("max",2,2,funcMax),new ObjNativeFunc("sqr",1,1,funcSqr),new ObjNativeFunc("str",1,1,funcStr),new ObjNativeFunc("val",1,1,funcVal),new ObjNativeFunc("starttimer",2,2,funcStartTimer),new ObjNativeFunc("stoptimer",0,0,funcStopTimer),new ObjNativeFunc("addarrayitem",2,3,funcAddArrayItem),new ObjNativeFunc("removearrayitem",2,2,funcRemoveArrayItem),new ObjNativeFunc("clamp",3,3,funcClamp),new ObjNativeFunc("pointinrect",6,6,funcPointInRect),new ObjNativeFunc("pointincircle",5,5,funcPointInCircle),new ObjNativeFunc("rectsoverlap",8,8,funcRectsOverlap),new ObjNativeFunc("circlesoverlap",6,6,funcCirclesOverlap),new ObjNativeFunc("rectoverlapscircle",7,7,funcRectOverlapsCircle),new ObjNativeFunc("cos",1,1,funcCos),new ObjNativeFunc("sin",1,1,funcSin),new ObjNativeFunc("tan",1,1,funcTan),new ObjNativeFunc("round",1,2,funcRound),new ObjNativeFunc("version",0,0,funcVersion),new ObjNativeFunc("word",2,3,funcWord),new ObjNativeFunc("splitstr",2,2,funcSplitStr),new ObjNativeFunc("pausefor",1,1,funcPauseFor)];var timerID=0,timerCallback=null,pauseForCallback=null;function timer_onTick(){0==timerID||timerCallback.runFunc()}function pauseFor_onTimeout(){pauseForCallback.runFunc()}function funcRnd(){return Math.random()}function funcTime(){return Date.now()}function funcInt(e,r){return parseInt(r[0])}function funcLen(e,r){var n;return n=r[0]instanceof ObjArray?r[0].items.length:r[0].length,n}function funcUpper(e,r){return r[0].toUpperCase()}function funcLower(e,r){return r[0].toLowerCase()}function funcLeft(e,r){return r[0].slice(0,r[1])}function funcRight(e,r){return r[0].slice(-r[1])}function funcMid(e,r){return 2==r.length?r[0].slice(r[1]-1):r[0].slice(r[1]-1,r[1]+r[2]-1)}function funcTrim(e,r){return r[0].trim()}function funcLTrim(e,r){return r[0].trimStart()}function funcRTrim(e,r){return r[0].trimEnd()}function funcInstr(e,r){return 2==r.length?r[0].indexOf(r[1])+1:r[0].indexOf(r[1],r[2]-1)+1}function funcAbs(e,r){return Math.abs(r[0])}function funcAsc(e,r){return r[0].charCodeAt(0)}function funcChr(e,r){return String.fromCharCode(r[0])}function funcMin(e,r){return Math.min(r[0],r[1])}function funcMax(e,r){return Math.max(r[0],r[1])}function funcSqr(e,r){return Math.sqrt(r[0])}function funcStr(e,r){return r[0].toString()}function funcVal(e,r){return parseFloat(r[0])}function funcStartTimer(e,r){var n=r[0],t=r[1];return t instanceof ObjUserFunc||e.endWithError("Second argument of startTimer() must be a function."),0!=t.paramCount&&e.endWithError("Callback function for startTimer() must have zero parameters."),0!=timerID&&clearInterval(timerID),null==timerCallback?timerCallback=new CallbackContext(e,t):(timerCallback.runtime=e,timerCallback.userFunc=t),timerID=setInterval(timer_onTick,n),0}function funcStopTimer(){return 0==timerID?0:(clearInterval(timerID),timerID=0,0)}function funcAddArrayItem(e,r){var n=r[0],t=r[1],a=-1,s="";return 3==r.length&&(a=r[2]),n instanceof ObjArray||e.endWithError("First argument of addArrayItem() must be an array."),s=n.addItem(t,a),""!=s&&e.endWithError(s),0}function funcRemoveArrayItem(e,r){var n=r[0],t=r[1],a="";return n instanceof ObjArray||e.endWithError("First argument of removeArrayItem() must be an array."),a=n.removeItem(t),""!=a&&e.endWithError(a),0}function funcClamp(e,r){var n=r[0],t=r[1],a=r[2];return Math.max(t,Math.min(n,a))}function funcPointInRect(e,r){var n=r[0],t=r[1],a=r[2],s=r[3],o=r[4],c=r[5];return!(n<=a||n>=a+o)&&!(t<=s||t>=s+c)}function funcPointInCircle(e,r){var n=r[0],t=r[1],a=r[2],s=r[3],o=r[4],c=Math.pow(a-n,2)+Math.pow(s-t,2);return c<Math.pow(o,2)}function funcRectsOverlap(e,r){var n=r[0],t=r[1],a=r[2],s=r[3],o=r[4],c=r[5],i=r[6],p=r[7];return!(n+a<=o||n>=o+i)&&!(t+s<=c||t>=c+p)}function funcCirclesOverlap(e,r){var n=r[0],t=r[1],a=r[2],s=r[3],o=r[4],c=r[5],i=Math.pow(n-s,2)+Math.pow(t-o,2);return i<Math.pow(a+c,2)}function funcRectOverlapsCircle(e,r){var n=r[0],t=r[1],a=r[2],s=r[3],o=r[4],c=r[5],i=r[6],p=Math.max(n,Math.min(o,n+a)),d=Math.max(t,Math.min(c,t+s)),u=Math.pow(o-p,2)+Math.pow(c-d,2);return u<Math.pow(i,2)}function funcCos(e,r){var n=r[0];return Math.cos(n)}function funcSin(e,r){var n=r[0];return Math.sin(n)}function funcTan(e,r){var n=r[0];return Math.tan(n)}function funcRound(e,r){var n,t=r[0];return 1==r.length?Math.round(t):(n=r[1],parseFloat(parseFloat(t).toFixed(n)))}function funcVersion(){return lbVersion}function funcWord(e,r){var n,t=r[0],a=r[1]-1,s=" ";return 3==r.length&&(s=r[2]),n=t.split(s),0>a||a>=n.length?"":n[a]}function funcSplitStr(e,r){var n,t,a=r[0],s=r[1];return n=a.split(s),t=new ObjArray,t.reDim([n.length]),n.forEach((e,r)=>t.items[r]=e),t}function funcPauseFor(e,r){var n=r[0];return null==pauseForCallback?pauseForCallback=new CallbackContext(e):pauseForCallback.runtime=e,e.status=RUNTIME_STATUS_PAUSED,setTimeout(pauseFor_onTimeout,n),0}const keywordList={true:TOKEN_TRUE,false:TOKEN_FALSE,not:TOKEN_NOT,or:TOKEN_OR,and:TOKEN_AND,var:TOKEN_VAR,array:TOKEN_ARRAY,print:TOKEN_PRINT,if:TOKEN_IF,then:TOKEN_THEN,else:TOKEN_ELSE,end:TOKEN_END,while:TOKEN_WHILE,wend:TOKEN_WEND,for:TOKEN_FOR,to:TOKEN_TO,step:TOKEN_STEP,next:TOKEN_NEXT,redim:TOKEN_REDIM,cls:TOKEN_CLS,whterbtobj:TOKEN_WHTERBTOBJ,do:TOKEN_DO,loop:TOKEN_LOOP,exit:TOKEN_EXIT,function:TOKEN_FUNCTION,return:TOKEN_RETURN,wait:TOKEN_WAIT,structure:TOKEN_STRUCTURE,new:TOKEN_NEW};class Scanner{constructor(e){this.source=e,this.startCharIndex=0,this.currCharIndex=0,this.currLineNum=1}scanToken(){var e,r;return(this.skipWhitespace(),this.startCharIndex=this.currCharIndex,this.endOfSource())?this.makeEOFToken():(e=this.consumeChar(),"\n"===e?(r=this.makeToken(TOKEN_NEWLINE),this.currLineNum++,r):":"===e?this.makeToken(TOKEN_COLON):"_"===e?this.makeToken(TOKEN_UNDERSCORE):"("===e?this.makeToken(TOKEN_LEFT_PAREN):")"===e?this.makeToken(TOKEN_RIGHT_PAREN):"["===e?this.makeToken(TOKEN_LEFT_BRACKET):"]"===e?this.makeToken(TOKEN_RIGHT_BRACKET):","===e?this.makeToken(TOKEN_COMMA):"."===e?this.makeToken(TOKEN_DOT):"-"===e?this.makeToken(TOKEN_MINUS):"+"===e?this.makeToken(TOKEN_PLUS):"/"===e?this.makeToken(TOKEN_SLASH):"*"===e?this.makeToken(TOKEN_STAR):"%"===e?this.makeToken(TOKEN_PERCENT):"="===e?this.makeToken(TOKEN_EQUAL):"^"===e?this.makeToken(TOKEN_CARET):">"===e?this.makeToken(this.matchChar("=")?TOKEN_GREATER_EQUAL:TOKEN_GREATER):"<"===e?this.makeToken(this.matchChar("=")?TOKEN_LESS_EQUAL:this.matchChar(">")?TOKEN_NOT_EQUAL:TOKEN_LESS):"\""===e?this.consumeStringLiteral():this.isDigit(e)?this.consumeNumberLiteral():this.isAlpha(e)?this.consumeIdentifier():this.makeErrorToken("Unrecognized character: '"+e+"'"))}makeToken(e,r){var n=this.source.substring(this.startCharIndex,this.currCharIndex);return new Token(e,n,r,this.currLineNum)}makeErrorToken(e){return new Token(TOKEN_ERROR,e,void 0,this.currLineNum)}makeEOFToken(){return new Token(TOKEN_EOF,"EOF",void 0,this.currLineNum)}skipWhitespace(){for(var e;;)switch(e=this.peekChar(),e){case" ":case"\r":case"\t":this.consumeChar();break;case"'":for(;"\n"!=this.peekChar()&&!this.endOfSource();)this.consumeChar();break;default:return;}}consumeStringLiteral(){for(var e;"\""!=this.peekChar()&&"\n"!=this.peekChar()&&!this.endOfSource();)this.consumeChar();return"\n"==this.peekChar()||this.endOfSource()?this.makeErrorToken("Unterminated string."):(this.consumeChar(),e=this.source.substring(this.startCharIndex+1,this.currCharIndex-1),this.makeToken(TOKEN_STRING_LIT,e))}consumeNumberLiteral(){for(var e;this.isDigit(this.peekChar());)this.consumeChar();if("."==this.peekChar()&&this.isDigit(this.peekNextChar()))for(this.consumeChar();this.isDigit(this.peekChar());)this.consumeChar();return e=+this.source.substring(this.startCharIndex,this.currCharIndex),this.makeToken(TOKEN_NUMBER_LIT,e)}consumeIdentifier(){for(var e,r;this.isAlphaNumeric(this.peekChar());)this.consumeChar();return e=this.source.substring(this.startCharIndex,this.currCharIndex).toLowerCase(),r=keywordList.hasOwnProperty(e)?keywordList[e]:TOKEN_IDENTIFIER,this.makeToken(r)}isAlpha(e){return /^[A-Za-z]$/.test(e)}isDigit(e){return /^[0-9]$/.test(e)}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}consumeChar(){return this.source.charAt(this.currCharIndex++)}matchChar(e){return!this.endOfSource()&&!(this.source.charAt(this.currCharIndex)!=e)&&(this.currCharIndex++,!0)}peekChar(){return this.endOfSource()?"\0":this.source.charAt(this.currCharIndex)}peekNextChar(){return this.currCharIndex+1>=this.source.length?"\0":this.source.charAt(this.currCharIndex+1)}endOfSource(){return this.currCharIndex>=this.source.length}}class VariableReference{constructor(e,r){this.scope=e,this.index=r}}class Compiler{constructor(e,r=[]){this.source=e,this.scanner=new Scanner(e),this.bytecode=new Bytecode,this.bytecode.nativeFuncs=[].concat(stdNativeFuncs,r),this.mainUserFunc=null,this.currUserFunc=null,this.currTokens=null,this.currTokenIndex=0,this.exitWhileOpIndexes=[],this.exitForOpIndexes=[],this.exitDoOpIndexes=[],this.error=null}compile(){try{this.scanTokens(),this.parseStructDefs(),this.parseUserFuncs()}catch(e){this.error=e}return this.bytecode}scanTokens(){var e,r,n,t=!1,a=!1;this.mainUserFunc=new ObjUserFunc("<main>"),this.bytecode.userFuncs.push(this.mainUserFunc),n=this.mainUserFunc.tokens;do switch(e=this.scanner.scanToken(),e.type){case TOKEN_ERROR:this.raiseError(e.lexeme,e);break;case TOKEN_NEWLINE:0<n.length?n[n.length-1].type!=TOKEN_NEWLINE&&n.push(e):a&&n.push(e);break;case TOKEN_COLON:0<n.length?n[n.length-1].type!=TOKEN_COLON&&n.push(e):a&&n.push(e);break;case TOKEN_UNDERSCORE:r=e,e=this.scanner.scanToken(),e.type!=TOKEN_NEWLINE&&(n.push(r),n.push(e));break;case TOKEN_FUNCTION:t&&this.raiseError("Cannot have nested functions.",e),a&&this.raiseError("Cannot have functions within structures.",e),e=this.scanner.scanToken(),e.type!=TOKEN_IDENTIFIER&&this.raiseError("Expected identifier after 'function'.",e),-1!=this.getNativeFuncIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a function.",e),-1!=this.getUserFuncIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a function.",e),-1!=this.getStructDefIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a structure.",e),this.bytecode.userFuncs.push(new ObjUserFunc(e.lexeme)),n=this.bytecode.userFuncs[this.bytecode.userFuncs.length-1].tokens,t=!0;break;case TOKEN_STRUCTURE:a&&this.raiseError("Cannot have nested structures.",e),t&&this.raiseError("Cannot have structures within functions.",e),e=this.scanner.scanToken(),e.type!=TOKEN_IDENTIFIER&&this.raiseError("Expected identifier after 'structure'.",e),-1!=this.getNativeFuncIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a function.",e),-1!=this.getUserFuncIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a function.",e),-1!=this.getStructDefIndex(e.lexeme)&&this.raiseError("'"+e.lexeme+"' is already a structure.",e),this.bytecode.structDefs.push(new StructureDef(e.lexeme)),n=this.bytecode.structDefs[this.bytecode.structDefs.length-1].tokens,a=!0;break;case TOKEN_END:r=e,e=this.scanner.scanToken(),e.type==TOKEN_FUNCTION?(!t&&this.raiseError("'end function' without 'function'.",e),n.push(this.scanner.makeEOFToken()),n=this.mainUserFunc.tokens,t=!1):e.type==TOKEN_STRUCTURE?(!a&&this.raiseError("'end structure' without 'structure'.",e),n.push(this.scanner.makeEOFToken()),n=this.mainUserFunc.tokens,a=!1):(n.push(r),n.push(e));break;default:n.push(e);}while(e.type!=TOKEN_EOF);t&&this.raiseError("'function' without 'end function'.",n[0]),a&&this.raiseError("'structure' without 'end structure'.",n[0])}parseStructDefs(){for(var e=0;e<this.bytecode.structDefs.length;e++){for(this.currTokens=this.bytecode.structDefs[e].tokens,this.matchTerminator()||this.raiseError("Expected terminator.");!this.endOfTokens();)this.matchToken(TOKEN_IDENTIFIER)||this.raiseError("Expected identifier."),this.bytecode.structDefs[e].fieldIdents.push(this.prevToken().lexeme),this.matchTerminator()||this.raiseError("Expected terminator after identifier.");this.currTokens.splice(0),this.currTokenIndex=0}}parseUserFuncs(){for(var e=0;e<this.bytecode.userFuncs.length;e++){for(this.currUserFunc=this.bytecode.userFuncs[e],this.currTokens=this.currUserFunc.tokens,this.currUserFunc!=this.mainUserFunc&&this.parseParameters();!this.endOfTokens();)this.parseStatement();this.addReturnOps(),this.currTokens.splice(0),this.currTokenIndex=0}}parseStatement(e=!0){this.matchToken(TOKEN_VAR)?this.varStmt():this.matchToken(TOKEN_ARRAY)?this.arrayStmt():this.matchToken(TOKEN_PRINT)?this.printStmt():this.matchToken(TOKEN_IF)?this.ifStmt():this.matchToken(TOKEN_ELSE)?this.raiseError("'else' without matching 'if' statement."):this.matchTokenPair(TOKEN_END,TOKEN_IF)?this.raiseError("'end if' without matching 'if' statement."):this.matchToken(TOKEN_WHILE)?this.whileStmt():this.matchToken(TOKEN_WEND)?this.raiseError("'wend' without matching 'while' statement."):this.matchToken(TOKEN_FOR)?this.forStmt():this.matchToken(TOKEN_NEXT)?this.raiseError("'next' without matching 'for' statement."):this.matchToken(TOKEN_END)?this.endStmt():this.matchToken(TOKEN_REDIM)?this.reDimStmt():this.matchToken(TOKEN_CLS)?this.clsStmt():this.matchToken(TOKEN_WHTERBTOBJ)?this.whteRbtObjStmt():this.matchToken(TOKEN_DO)?this.doStmt():this.matchTokenPair(TOKEN_LOOP,TOKEN_WHILE)?this.raiseError("'loop while' without matching 'do' statement."):this.matchTokenPair(TOKEN_EXIT,TOKEN_WHILE)?this.exitWhileStmt():this.matchTokenPair(TOKEN_EXIT,TOKEN_FOR)?this.exitForStmt():this.matchTokenPair(TOKEN_EXIT,TOKEN_DO)?this.exitDoStmt():this.matchToken(TOKEN_RETURN)?this.returnStmt():this.matchToken(TOKEN_WAIT)?this.waitStmt():this.exprStmt(),e&&!this.matchTerminator()&&this.raiseError("Expected terminator after statement.")}varStmt(){var e,r;do this.matchToken(TOKEN_IDENTIFIER)?(e=this.prevToken().lexeme,r=this.addVariable(e)):this.raiseError("Expected identifier."),this.matchToken(TOKEN_EQUAL)&&(this.parseExpression(),this.addOp([OPCODE_STORE_VAR,r.scope,r.index]));while(this.matchToken(TOKEN_COMMA))}arrayStmt(){var e,r,n;this.matchToken(TOKEN_IDENTIFIER)?(e=this.prevToken().lexeme,r=this.addVariable(e)):this.raiseError("Expected identifier."),this.matchToken(TOKEN_LEFT_BRACKET)||this.raiseError("Expected '[' after identifier."),n=this.parseArguments(),0==n&&this.raiseError("Expected one or more dimension expressions."),this.matchToken(TOKEN_RIGHT_BRACKET)||this.raiseError("Expected ']' after dimensions."),this.addOp([OPCODE_CREATE_ARRAY,n]),this.addOp([OPCODE_STORE_VAR,r.scope,r.index])}exprStmt(){this.parseExpression(!0),this.addOp([OPCODE_POP])}printStmt(){this.parseExpression(),this.addOp([OPCODE_PRINT])}ifStmt(){var e,r;if(this.parseExpression(),this.matchToken(TOKEN_THEN)||this.raiseError("Expected 'then' after expression."),e=this.addOp([OPCODE_JUMP_IF_FALSE,0]),!this.matchTerminator())return this.parseStatement(!1),void this.patchJumpOp(e);for(;!this.checkTokenPair(TOKEN_END,TOKEN_IF)&&!this.checkToken(TOKEN_ELSE)&&!this.endOfTokens();)this.parseStatement();if(this.endOfTokens()&&this.raiseError("Expected either 'else' or 'end if' at the end of 'if' block."),this.matchTokenPair(TOKEN_END,TOKEN_IF))this.patchJumpOp(e);else if(this.matchToken(TOKEN_ELSE)){for(this.matchTerminator()||this.raiseError("Expected terminator after 'else'."),r=this.addOp([OPCODE_JUMP,0]),this.patchJumpOp(e);!this.checkTokenPair(TOKEN_END,TOKEN_IF)&&!this.endOfTokens();)this.parseStatement();this.matchTokenPair(TOKEN_END,TOKEN_IF)||this.raiseError("Expected 'end if' at the end of 'else' block."),this.patchJumpOp(r)}}whileStmt(){var e,r=this.opsCount();for(this.parseExpression(),this.matchTerminator()||this.raiseError("Expected terminator after expression."),e=this.addOp([OPCODE_JUMP_IF_FALSE,0]),this.exitWhileOpIndexes.push([]);!this.checkToken(TOKEN_WEND)&&!this.endOfTokens();)this.parseStatement();this.matchToken(TOKEN_WEND)||this.raiseError("Expected 'wend' at the end of 'while' block."),this.addOp([OPCODE_JUMP,r]),this.patchJumpOp(e);for(var t=0;t<this.exitWhileOpIndexes[this.exitWhileOpIndexes.length-1].length;t++)this.patchJumpOp(this.exitWhileOpIndexes[this.exitWhileOpIndexes.length-1][t]);this.exitWhileOpIndexes.pop()}forStmt(){var e,r,t,a;for(this.matchToken(TOKEN_IDENTIFIER)||this.raiseError("Expected identifier after 'for'."),e=this.prevToken().lexeme,r=this.getVariableReference(e),this.matchToken(TOKEN_EQUAL)||this.raiseError("Expected '=' after identifier."),this.parseExpression(),this.addOp([OPCODE_STORE_VAR,r.scope,r.index]),this.matchToken(TOKEN_TO)||this.raiseError("Expected 'to' after start expression."),this.parseExpression(),this.matchToken(TOKEN_STEP)?this.parseExpression():this.addOp([OPCODE_LOAD_INT,1]),this.matchTerminator()||this.raiseError("Expected terminator after expression."),this.addOp([OPCODE_LOAD_VAR,r.scope,r.index]),a=this.opsCount(),this.addOp([OPCODE_CHECK_COUNTER]),t=this.addOp([OPCODE_JUMP_IF_TRUE,0]),this.exitForOpIndexes.push([]);!this.checkToken(TOKEN_NEXT)&&!this.endOfTokens();)this.parseStatement();this.matchToken(TOKEN_NEXT)||this.raiseError("Expected 'next' at the end of 'for' block."),this.matchToken(TOKEN_IDENTIFIER)&&e!=this.prevToken().lexeme&&this.raiseError("Identifier '"+this.prevToken().lexeme+"' does not match identifier '"+e+"' given in 'for' statement."),this.addOp([OPCODE_INCREMENT_COUNTER]),this.addOp([OPCODE_STORE_VAR_PERSIST,r.scope,r.index]),this.addOp([OPCODE_JUMP,a]),this.patchJumpOp(t);for(var s=0;s<this.exitForOpIndexes[this.exitForOpIndexes.length-1].length;s++)this.patchJumpOp(this.exitForOpIndexes[this.exitForOpIndexes.length-1][s]);this.exitForOpIndexes.pop(),this.addOp([OPCODE_POP]),this.addOp([OPCODE_POP]),this.addOp([OPCODE_POP])}endStmt(){this.addOp([OPCODE_END])}reDimStmt(){var e,r,n;this.matchToken(TOKEN_IDENTIFIER)?(e=this.prevToken().lexeme,r=this.getVariableReference(e),this.addOp([OPCODE_LOAD_VAR,r.scope,r.index])):this.raiseError("Expected identifier."),this.matchToken(TOKEN_LEFT_BRACKET)||this.raiseError("Expected '[' after identifier"),n=this.parseArguments(),0==n&&this.raiseError("Expected one or more dimension expressions."),this.matchToken(TOKEN_RIGHT_BRACKET)||this.raiseError("Expected ']' after indexes"),this.addOp([OPCODE_REDIM_ARRAY,n])}clsStmt(){this.addOp([OPCODE_CLS])}whteRbtObjStmt(){for(var e=0;10>e;e++)this.addOp([OPCODE_LOAD_LIT,this.getLiteralIndex("Ah ah ah, you didn't say the magic word!")]),this.addOp([OPCODE_PRINT])}doStmt(){var e=this.opsCount();for(this.matchTerminator()||this.raiseError("Expected statement terminator after 'do'."),this.exitDoOpIndexes.push([]);!this.endOfTokens()&&!this.checkTokenPair(TOKEN_LOOP,TOKEN_WHILE);)this.parseStatement();this.matchTokenPair(TOKEN_LOOP,TOKEN_WHILE)||this.raiseError("Expected 'loop while' at the end of 'do' block."),this.parseExpression(),this.addOp([OPCODE_JUMP_IF_TRUE,e]);for(var r=0;r<this.exitDoOpIndexes[this.exitDoOpIndexes.length-1].length;r++)this.patchJumpOp(this.exitDoOpIndexes[this.exitDoOpIndexes.length-1][r]);this.exitDoOpIndexes.pop()}exitWhileStmt(){var e;0==this.exitWhileOpIndexes.length&&this.raiseError("'exit while' outside of 'while' block."),e=this.addOp([OPCODE_JUMP,0]),this.exitWhileOpIndexes[this.exitWhileOpIndexes.length-1].push(e)}exitForStmt(){var e;0==this.exitForOpIndexes.length&&this.raiseError("'exit for' outside of 'for' block."),e=this.addOp([OPCODE_JUMP,0]),this.exitForOpIndexes[this.exitForOpIndexes.length-1].push(e)}exitDoStmt(){var e;0==this.exitDoOpIndexes.length&&this.raiseError("'exit do' outside of 'do' block."),e=this.addOp([OPCODE_JUMP,0]),this.exitDoOpIndexes[this.exitDoOpIndexes.length-1].push(e)}returnStmt(){this.currUserFunc==this.mainUserFunc&&this.raiseError("'return' only allowed within a function."),this.checkTerminator()?this.addReturnOps():(this.parseExpression(),this.addOp([OPCODE_RETURN]))}waitStmt(){var e;e=this.addOp([OPCODE_PAUSE]),this.addOp([OPCODE_JUMP,e])}parseExpression(e=!1){this.logicOrExpr(e)}logicOrExpr(e){var r;for(this.logicAndExpr(e);this.matchToken(TOKEN_OR);)r=this.addOp([OPCODE_JUMP_IF_TRUE_PERSIST,0]),this.addOp([OPCODE_POP]),this.logicAndExpr(e),this.patchJumpOp(r)}logicAndExpr(e){var r;for(this.equalityExpr(e);this.matchToken(TOKEN_AND);)r=this.addOp([OPCODE_JUMP_IF_FALSE_PERSIST,0]),this.addOp([OPCODE_POP]),this.equalityExpr(e),this.patchJumpOp(r)}equalityExpr(e){var r;for(this.comparisonExpr(e);this.matchTokenList([TOKEN_EQUAL,TOKEN_NOT_EQUAL]);)r=this.prevToken().type,this.comparisonExpr(e),r===TOKEN_EQUAL?this.addOp([OPCODE_EQUAL]):r===TOKEN_NOT_EQUAL?(this.addOp([OPCODE_EQUAL]),this.addOp([OPCODE_NOT])):void 0}comparisonExpr(e){var r;for(this.termExpr(e);this.matchTokenList([TOKEN_GREATER,TOKEN_GREATER_EQUAL,TOKEN_LESS,TOKEN_LESS_EQUAL]);)r=this.prevToken().type,this.termExpr(e),r===TOKEN_GREATER?this.addOp([OPCODE_GREATER]):r===TOKEN_GREATER_EQUAL?(this.addOp([OPCODE_LESS]),this.addOp([OPCODE_NOT])):r===TOKEN_LESS?this.addOp([OPCODE_LESS]):r===TOKEN_LESS_EQUAL?(this.addOp([OPCODE_GREATER]),this.addOp([OPCODE_NOT])):void 0}termExpr(e){var r;for(this.factorExpr(e);this.matchTokenList([TOKEN_MINUS,TOKEN_PLUS]);)r=this.prevToken().type,this.factorExpr(e),r===TOKEN_MINUS?this.addOp([OPCODE_SUB]):r===TOKEN_PLUS?this.addOp([OPCODE_ADD]):void 0}factorExpr(e){var r;for(this.powerExpr(e);this.matchTokenList([TOKEN_SLASH,TOKEN_STAR,TOKEN_PERCENT]);)r=this.prevToken().type,this.powerExpr(e),r===TOKEN_SLASH?this.addOp([OPCODE_DIV]):r===TOKEN_STAR?this.addOp([OPCODE_MUL]):r===TOKEN_PERCENT?this.addOp([OPCODE_MOD]):void 0}powerExpr(e){for(this.unaryExpr(e);this.matchToken(TOKEN_CARET);)this.unaryExpr(e),this.addOp([OPCODE_POW])}unaryExpr(e){var r;return this.matchTokenList([TOKEN_MINUS,TOKEN_NOT])?(r=this.prevToken().type,this.unaryExpr(e),void(r===TOKEN_MINUS?this.addOp([OPCODE_NEGATE]):r===TOKEN_NOT?this.addOp([OPCODE_NOT]):void 0)):void this.postfixExpr(e)}postfixExpr(e){var r,n;for(this.newExpr(e);;)if(this.matchToken(TOKEN_LEFT_PAREN))r=this.parseArguments(),this.matchToken(TOKEN_RIGHT_PAREN)||this.raiseError("Expected ')' after function arguments."),this.addOp([OPCODE_CALL_FUNC,r]);else if(this.matchToken(TOKEN_DOT))this.matchToken(TOKEN_IDENTIFIER)||this.raiseError("Expected identifier after '.'."),n=this.prevToken().lexeme,this.addOp([OPCODE_LOAD_LIT,this.getLiteralIndex(n)]),e&&this.matchToken(TOKEN_EQUAL)?(this.parseExpression(),this.addOp([OPCODE_STORE_STRUCT_FIELD_PERSIST])):this.addOp([OPCODE_LOAD_STRUCT_FIELD]);else if(this.matchToken(TOKEN_LEFT_BRACKET))r=this.parseArguments(),this.matchToken(TOKEN_RIGHT_BRACKET)||this.raiseError("Expected ']' after array indexes."),e&&this.matchToken(TOKEN_EQUAL)?(this.parseExpression(),this.addOp([OPCODE_STORE_ARRAY_ITEM_PERSIST,r])):this.addOp([OPCODE_LOAD_ARRAY_ITEM,r]);else break}newExpr(e){var r,n,t;return this.matchToken(TOKEN_NEW)?void(this.matchToken(TOKEN_ARRAY)?(!this.matchToken(TOKEN_LEFT_BRACKET)&&this.raiseError("Expected '[' after 'array'."),r=this.parseArguments(),0==r&&this.raiseError("Expected one or more dimension expressions."),!this.matchToken(TOKEN_RIGHT_BRACKET)&&this.raiseError("Expected ']' after dimensions."),this.addOp([OPCODE_CREATE_ARRAY,r])):this.matchToken(TOKEN_IDENTIFIER)?(n=this.prevToken().lexeme,t=this.getStructDefIndex(n),-1==t&&this.raiseError("Structure '"+n+"' not defined."),this.addOp([OPCODE_CREATE_STRUCT,t])):this.raiseError("Expected 'array' or structure identifier after 'new'.")):void this.primaryExpr(e)}primaryExpr(e){var r,n,t,a,s;return this.matchToken(TOKEN_IDENTIFIER)?(r=this.prevToken().lexeme,n=this.getNativeFuncIndex(r),-1!=n)?void this.addOp([OPCODE_LOAD_NATIVE_FUNC,n]):(n=this.getUserFuncIndex(r),-1!=n)?void this.addOp([OPCODE_LOAD_USER_FUNC,n]):(t=this.getVariableReference(r),void(e&&this.matchToken(TOKEN_EQUAL)?(this.parseExpression(),this.addOp([OPCODE_STORE_VAR_PERSIST,t.scope,t.index])):this.addOp([OPCODE_LOAD_VAR,t.scope,t.index]))):this.matchToken(TOKEN_TRUE)?void this.addOp([OPCODE_LOAD_TRUE]):this.matchToken(TOKEN_FALSE)?void this.addOp([OPCODE_LOAD_FALSE]):this.matchTokenList([TOKEN_STRING_LIT,TOKEN_NUMBER_LIT])?(a=this.prevToken().literal,s=this.getLiteralIndex(a),void this.addOp([OPCODE_LOAD_LIT,s])):this.matchToken(TOKEN_LEFT_PAREN)?(this.parseExpression(),void(this.matchToken(TOKEN_RIGHT_PAREN)||this.raiseError("Expected ')' after expression."))):void this.raiseError("Expected expression.")}parseArguments(){var e=0;if(this.checkToken(TOKEN_RIGHT_PAREN))return e;do this.parseExpression(),e++;while(this.matchToken(TOKEN_COMMA));return e}parseParameters(){if(this.matchToken(TOKEN_LEFT_PAREN)||this.raiseError("Expected '(' after function identifier."),this.matchToken(TOKEN_RIGHT_PAREN))return void(this.matchTerminator()||this.raiseError("Expected terminator after ')'."));do this.matchToken(TOKEN_IDENTIFIER)||this.raiseError("Expected identifier for function parameter."),this.addVariable(this.prevToken().lexeme);while(this.matchToken(TOKEN_COMMA));this.matchToken(TOKEN_RIGHT_PAREN)||this.raiseError("Expected ')' after function parameters."),this.matchTerminator()||this.raiseError("Expected terminator after ')'."),this.currUserFunc.paramCount=this.currUserFunc.varIdents.length}addVariable(e){var r,n;for(-1!=this.getNativeFuncIndex(e)&&this.raiseError("'"+e+"' is already a function."),-1!=this.getUserFuncIndex(e)&&this.raiseError("'"+e+"' is already a function."),-1!=this.getStructDefIndex(e)&&this.raiseError("'"+e+"' is already a structure."),n=0;n<this.currUserFunc.varIdents.length;n++)this.currUserFunc.varIdents[n].toLowerCase()==e.toLowerCase()&&this.raiseError("Variable or array '"+e+"' already declared.");return this.currUserFunc.varIdents.push(e),n=this.currUserFunc.varIdents.length-1,r=this.currUserFunc==this.mainUserFunc?SCOPE_GLOBAL:SCOPE_LOCAL,new VariableReference(r,n)}getNativeFuncIndex(e){e=e.toLowerCase();for(var r=0;r<this.bytecode.nativeFuncs.length;r++)if(this.bytecode.nativeFuncs[r].ident.toLowerCase()==e)return r;return-1}getUserFuncIndex(e){e=e.toLowerCase();for(var r=0;r<this.bytecode.userFuncs.length;r++)if(this.bytecode.userFuncs[r].ident.toLowerCase()==e)return r;return-1}getStructDefIndex(e){e=e.toLowerCase();for(var r=0;r<this.bytecode.structDefs.length;r++)if(this.bytecode.structDefs[r].ident.toLowerCase()==e)return r;return-1}getLiteralIndex(e){var r=this.bytecode.literals.indexOf(e);return-1==r&&(this.bytecode.literals.push(e),r=this.bytecode.literals.length-1),r}getVariableReference(e){var r;if(this.currUserFunc!=this.mainUserFunc)for(r=0;r<this.currUserFunc.varIdents.length;r++)if(this.currUserFunc.varIdents[r].toLowerCase()==e.toLowerCase())return new VariableReference(SCOPE_LOCAL,r);for(r=0;r<this.mainUserFunc.varIdents.length;r++)if(this.mainUserFunc.varIdents[r].toLowerCase()==e.toLowerCase())return new VariableReference(SCOPE_GLOBAL,r);this.raiseError("Variable or array '"+e+"' not declared.")}addOp(e){return this.currUserFunc.ops.push(e),this.updateSourceLineMap(),this.opsCount()-1}patchJumpOp(e){this.currUserFunc.ops[e][1]=this.opsCount()}addReturnOps(){this.addOp([OPCODE_LOAD_INT,0]),this.addOp([OPCODE_RETURN])}opsCount(){return this.currUserFunc.ops.length}matchTerminator(){return this.matchTokenList([TOKEN_NEWLINE,TOKEN_COLON,TOKEN_EOF])}checkTerminator(){return this.checkTokenList([TOKEN_NEWLINE,TOKEN_COLON,TOKEN_EOF])}consumeToken(){return this.endOfTokens()||this.currTokenIndex++,this.prevToken()}matchTokenList(e){for(var r=0;r<e.length;r++)if(this.checkToken(e[r]))return this.consumeToken(),!0;return!1}matchTokenPair(e,r){return!!this.checkTokenPair(e,r)&&(this.consumeToken(),this.consumeToken(),!0)}matchToken(e){if(this.checkToken(e))return this.consumeToken(),!0}checkTokenList(e){for(var r=0;r<e.length;r++)if(this.checkToken(e[r]))return!0;return!1}checkTokenPair(e,r){return!!(this.checkToken(e)&&this.checkNextToken(r))}checkToken(e){return this.peekToken().type==e}checkNextToken(e){return this.peekNextToken().type==e}peekToken(){return this.currTokens[this.currTokenIndex]}peekNextToken(){return this.endOfTokens()?this.peekToken():this.currTokens[this.currTokenIndex+1]}prevToken(){return this.currTokens[this.currTokenIndex-1]}endOfTokens(){return this.peekToken().type==TOKEN_EOF}updateSourceLineMap(){var e,r=this.peekToken().lineNum,n=this.opsCount()-1,t=this.currUserFunc.sourceLineMap;e=t.has(r)?{startOpIndex:t.get(r).startOpIndex,endOpIndex:n}:{startOpIndex:n,endOpIndex:n},t.set(r,e)}raiseError(e,r=null){var n;throw n=null==r?this.peekToken().lineNum:r.lineNum,e="Compile error on line "+n+": "+e,{message:e,lineNum:n}}}const RUNTIME_STATUS_RUNNING=1,RUNTIME_STATUS_PAUSED=2,RUNTIME_STATUS_DONE=3;class CallbackContext{constructor(e,r=null){this.runtime=e,this.userFunc=r}runFunc(e=[]){var r=e.length,n=this.runtime.stack.length;if(this.runtime.status==RUNTIME_STATUS_PAUSED){if(null!=this.userFunc){this.runtime.stack.push(this.userFunc);for(var t=0;t<r;t++)this.runtime.stack.push(e[t]);this.runtime.callUserFunc(this.userFunc,r,n)}this.runtime.status=RUNTIME_STATUS_RUNNING,this.runtime.run()}}endRuntime(e){""!=e&&this.runtime.setError(e),this.runtime.status=RUNTIME_STATUS_DONE,this.runtime.cleanup()}}class CallFrame{constructor(e,r){this.func=e,this.stackIndex=r,this.nextOpIndex=0}}class Runtime{constructor(e){this.bytecode=e,this.callFrames=[],this.currCallFrame=null,this.stack=[],this.currOp=null,this.opFuncs=[null],this.onPrintJsFunc=null,this.onDoneJsFunc=null,this.status=RUNTIME_STATUS_RUNNING,this.error=null,this.opFuncs[OPCODE_LOAD_TRUE]=this.opLoadTrue.bind(this),this.opFuncs[OPCODE_LOAD_FALSE]=this.opLoadFalse.bind(this),this.opFuncs[OPCODE_LOAD_INT]=this.opLoadInt.bind(this),this.opFuncs[OPCODE_LOAD_NATIVE_FUNC]=this.opLoadNativeFunc.bind(this),this.opFuncs[OPCODE_LOAD_USER_FUNC]=this.opLoadUserFunc.bind(this),this.opFuncs[OPCODE_LOAD_LIT]=this.opLoadLit.bind(this),this.opFuncs[OPCODE_LOAD_VAR]=this.opLoadVar.bind(this),this.opFuncs[OPCODE_STORE_VAR]=this.opStoreVar.bind(this),this.opFuncs[OPCODE_STORE_VAR_PERSIST]=this.opStoreVarPersist.bind(this),this.opFuncs[OPCODE_POP]=this.opPop.bind(this),this.opFuncs[OPCODE_SUB]=this.opSub.bind(this),this.opFuncs[OPCODE_ADD]=this.opAdd.bind(this),this.opFuncs[OPCODE_DIV]=this.opDiv.bind(this),this.opFuncs[OPCODE_MUL]=this.opMul.bind(this),this.opFuncs[OPCODE_MOD]=this.opMod.bind(this),this.opFuncs[OPCODE_NEGATE]=this.opNegate.bind(this),this.opFuncs[OPCODE_NOT]=this.opNot.bind(this),this.opFuncs[OPCODE_EQUAL]=this.opEqual.bind(this),this.opFuncs[OPCODE_GREATER]=this.opGreater.bind(this),this.opFuncs[OPCODE_LESS]=this.opLess.bind(this),this.opFuncs[OPCODE_POW]=this.opPow.bind(this),this.opFuncs[OPCODE_PRINT]=this.opPrint.bind(this),this.opFuncs[OPCODE_JUMP]=this.opJump.bind(this),this.opFuncs[OPCODE_JUMP_IF_FALSE]=this.opJumpIfFalse.bind(this),this.opFuncs[OPCODE_JUMP_IF_FALSE_PERSIST]=this.opJumpIfFalsePersist.bind(this),this.opFuncs[OPCODE_JUMP_IF_TRUE]=this.opJumpIfTrue.bind(this),this.opFuncs[OPCODE_JUMP_IF_TRUE_PERSIST]=this.opJumpIfTruePersist.bind(this),this.opFuncs[OPCODE_END]=this.opEnd.bind(this),this.opFuncs[OPCODE_CALL_FUNC]=this.opCallFunc.bind(this),this.opFuncs[OPCODE_CREATE_ARRAY]=this.opCreateArray.bind(this),this.opFuncs[OPCODE_REDIM_ARRAY]=this.opReDimArray.bind(this),this.opFuncs[OPCODE_LOAD_ARRAY_ITEM]=this.opLoadArrayItem.bind(this),this.opFuncs[OPCODE_STORE_ARRAY_ITEM_PERSIST]=this.opStoreArrayItemPersist.bind(this),this.opFuncs[OPCODE_CLS]=this.opCls.bind(this),this.opFuncs[OPCODE_CHECK_COUNTER]=this.opCheckCounter.bind(this),this.opFuncs[OPCODE_INCREMENT_COUNTER]=this.opIncrementCounter.bind(this),this.opFuncs[OPCODE_RETURN]=this.opReturn.bind(this),this.opFuncs[OPCODE_PAUSE]=this.opPause.bind(this),this.opFuncs[OPCODE_CREATE_STRUCT]=this.opCreateStruct.bind(this),this.opFuncs[OPCODE_LOAD_STRUCT_FIELD]=this.opLoadStructField.bind(this),this.opFuncs[OPCODE_STORE_STRUCT_FIELD_PERSIST]=this.opStoreStructFieldPersist.bind(this),this.stack.push(this.bytecode.userFuncs[0]),this.callUserFunc(this.bytecode.userFuncs[0],0,0)}run(){try{for(;this.status==RUNTIME_STATUS_RUNNING;)this.currOp=this.currCallFrame.func.ops[this.currCallFrame.nextOpIndex],this.currCallFrame.nextOpIndex++,this.opFuncs[this.currOp[0]]()}catch(e){}this.status==RUNTIME_STATUS_DONE&&this.cleanup()}opLoadTrue(){this.stack.push(!0)}opLoadFalse(){this.stack.push(!1)}opLoadInt(){this.stack.push(this.currOp[1])}opLoadNativeFunc(){var e=this.currOp[1],r=this.bytecode.nativeFuncs[e];this.stack.push(r)}opLoadUserFunc(){var e=this.currOp[1],r=this.bytecode.userFuncs[e];this.stack.push(r)}opLoadLit(){var e=this.currOp[1],r=this.bytecode.literals[e];this.stack.push(r)}opLoadVar(){var e,r=this.currOp[1],n=this.currOp[2]+1;e=r==SCOPE_GLOBAL?this.stack[n]:this.stack[this.currCallFrame.stackIndex+n],this.stack.push(e)}opStoreVar(){var e=this.currOp[1],r=this.currOp[2]+1,n=this.stack.pop();e==SCOPE_GLOBAL?this.stack[r]=n:this.stack[this.currCallFrame.stackIndex+r]=n}opStoreVarPersist(){var e=this.currOp[1],r=this.currOp[2]+1,n=this.stack[this.stack.length-1];e==SCOPE_GLOBAL?this.stack[r]=n:this.stack[this.currCallFrame.stackIndex+r]=n}opPop(){this.stack.pop()}opSub(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r-e)}opAdd(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r+e)}opDiv(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r/e)}opMul(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r*e)}opMod(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r%e)}opNegate(){var e=this.stack.pop();this.stack.push(-e)}opNot(){var e=this.stack.pop();this.stack.push(!e)}opEqual(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r==e)}opGreater(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r>e)}opLess(){var e=this.stack.pop(),r=this.stack.pop();this.stack.push(r<e)}opPow(){var e=this.stack.pop(),r=this.stack.pop(),n=Math.pow(r,e);this.stack.push(n)}opPrint(){var e=this.stack.pop();e+="\n",null!=this.onPrintJsFunc&&this.onPrintJsFunc(this,e,!1)}opJump(){var e=this.currOp[1];this.currCallFrame.nextOpIndex=e}opJumpIfFalse(){var e=this.currOp[1],r=this.stack.pop();r||(this.currCallFrame.nextOpIndex=e)}opJumpIfFalsePersist(){var e=this.currOp[1],r=this.stack[this.stack.length-1];r||(this.currCallFrame.nextOpIndex=e)}opJumpIfTrue(){var e=this.currOp[1],r=this.stack.pop();r&&(this.currCallFrame.nextOpIndex=e)}opJumpIfTruePersist(){var e=this.currOp[1],r=this.stack[this.stack.length-1];r&&(this.currCallFrame.nextOpIndex=e)}opEnd(){this.status=RUNTIME_STATUS_DONE}opCallFunc(){var e=this.currOp[1],r=this.stack.length-e-1,n=this.stack[r];n instanceof ObjNativeFunc?this.callNativeFunc(n,e):n instanceof ObjUserFunc?this.callUserFunc(n,e,r):this.endWithError("Can only call functions.")}opCreateArray(){for(var e,r=this.currOp[1],t=Array(r).fill(0),a=r-1;0<=a;a--)t[a]=this.stack.pop();e=new ObjArray,e.reDim(t),this.stack.push(e)}opReDimArray(){for(var e,r=this.currOp[1],t=Array(r).fill(0),a=r-1;0<=a;a--)t[a]=this.stack.pop();e=this.stack.pop(),e instanceof ObjArray||this.endWithError("Expected array."),e.reDim(t)}opLoadArrayItem(){for(var e,r,t=this.currOp[1],a=Array(t).fill(0),s=t-1;0<=s;s--)a[s]=this.stack.pop();e=this.stack.pop(),e instanceof ObjArray||this.endWithError("Expected array."),r=e.getLinearIndex(a),0>r&&this.endWithError("Array index out of bounds."),this.stack.push(e.items[r])}opStoreArrayItemPersist(){for(var e,r,t=this.currOp[1],a=Array(t).fill(0),s=this.stack.pop(),o=t-1;0<=o;o--)a[o]=this.stack.pop();e=this.stack.pop(),e instanceof ObjArray||this.endWithError("Expected array."),r=e.getLinearIndex(a),0>r&&this.endWithError("Array index out of bounds."),e.items[r]=s,this.stack.push(s)}opCls(){null!=this.onPrintJsFunc&&this.onPrintJsFunc(this,"",!0)}opCheckCounter(){var e=this.stack[this.stack.length-1],r=this.stack[this.stack.length-2],n=this.stack[this.stack.length-3];0<r?e>n?this.stack.push(!0):this.stack.push(!1):e<n?this.stack.push(!0):this.stack.push(!1)}opIncrementCounter(){var e=this.stack[this.stack.length-1],r=this.stack[this.stack.length-2];this.stack[this.stack.length-1]=e+r}opReturn(){this.stack.splice(this.currCallFrame.stackIndex,this.stack.length-this.currCallFrame.stackIndex-1),this.callFrames.pop(),0==this.callFrames.length?(this.currCallFrame=null,this.status=RUNTIME_STATUS_DONE):this.currCallFrame=this.callFrames[this.callFrames.length-1]}opPause(){this.status=RUNTIME_STATUS_PAUSED}opCreateStruct(){var e=this.currOp[1],r=this.bytecode.structDefs[e],n=new ObjStructure(r);this.stack.push(n)}opLoadStructField(){var e=this.stack.pop(),r=this.stack.pop();r instanceof ObjStructure||this.endWithError("Expected structure."),r.fieldMap.has(e)||this.endWithError("Structure field '"+e+"' not defined."),this.stack.push(r.fieldMap.get(e))}opStoreStructFieldPersist(){var e=this.stack.pop(),r=this.stack.pop(),n=this.stack.pop();n instanceof ObjStructure||this.endWithError("Expected structure."),n.fieldMap.has(r)||this.endWithError("Structure field '"+r+"' not defined."),n.fieldMap.set(r,e),this.stack.push(e)}callNativeFunc(e,r){var n,t;(r<e.paramMin||r>e.paramMax)&&this.endWithError("Wrong number of arguments for function '"+e.ident+"'."),n=this.stack.splice(this.stack.length-r,r),this.stack.pop(),t=e.jsFunc(this,n),this.stack.push(t)}callUserFunc(e,r,t){r!=e.paramCount&&this.endWithError("Wrong number of arguments for function '"+e.ident+"'."),this.callFrames.push(new CallFrame(e,t));for(var a=e.paramCount;a<e.varIdents.length;a++)this.stack.push(0);this.currCallFrame=this.callFrames[this.callFrames.length-1]}endWithError(e){throw this.setError(e),this.status=RUNTIME_STATUS_DONE,this.error}setError(e){var r=this.getSourceLine();e="Runtime error on line "+r+": "+e,this.error={message:e,lineNum:r}}getSourceLine(){var e=this.currCallFrame.nextOpIndex-1,r=this.currCallFrame.func.sourceLineMap;for(let[n,t]of r)if(e>=t.startOpIndex&&e<=t.endOpIndex)return n}cleanup(){this.stack.splice(0),this.callFrames.splice(0),null!=this.onDoneJsFunc&&this.onDoneJsFunc(this)}}
